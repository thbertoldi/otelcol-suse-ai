receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  prometheus:
    config:
      scrape_configs:
        - job_name: 'vllm'
          scrape_interval: 10s
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_app]
              action: keep
              regex: 'vllm'
            - source_labels: [__meta_kubernetes_pod_container_port_number]
              action: keep
              regex: '8000'

        - job_name: 'milvus'
          scrape_interval: 15s
          static_configs:
            - targets: ['milvus.suse-ai.svc.cluster.local:9091']

        - job_name: 'qdrant'
          scrape_interval: 15s
          static_configs:
            - targets: ['qdrant.suse-ai.svc.cluster.local:6333']

        - job_name: 'gpu-metrics'
          scrape_interval: 10s
          kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                  - gpu-operator

  elasticsearch:
    endpoint: "http://opensearch.suse-ai.svc.cluster.local:9200"
    collection_interval: 15s

processors:
  resourcedetection:
    detectors: [env, system, k8s]

  k8sattributes:
    auth_type: "kubeconfig"
    passthrough: false
    extract:
      metadata:
        - k8s.pod.name
        - k8s.pod.uid
        - k8s.namespace.name
        - k8s.deployment.name
        - k8s.statefulset.name
        - k8s.daemonset.name
        - k8s.cronjob.name
        - k8s.job.name
        - k8s.node.name
        - k8s.cluster.name

  transform:
    error_mode: ignore
    trace_statements:
      - context: span
        statements:
          # Promotion of GenAI attributes to Resource level
          - set(resource.attributes["gen_ai.system"], attributes["gen_ai.system"]) where attributes["gen_ai.system"] != nil
          - set(resource.attributes["gen_ai.provider.name"], attributes["gen_ai.provider.name"]) where attributes["gen_ai.provider.name"] != nil
          # Aggregation of models (last one wins in this context, usually sufficient per trace segment)
          - set(resource.attributes["gen_ai.models"], attributes["gen_ai.request.model"]) where attributes["gen_ai.request.model"] != nil
          # Normalization of legacy attributes
          - set(attributes["gen_ai.system"], attributes["GenAiSystem"]) where attributes["GenAiSystem"] != nil
          - set(attributes["gen_ai.operation.name"], attributes["GenAiOperationName"]) where attributes["GenAiOperationName"] != nil
          - set(attributes["gen_ai.request.model"], attributes["GenAiRequestModel"]) where attributes["GenAiRequestModel"] != nil

    metric_statements:
      - context: datapoint
        statements:
          # Promotion of GenAI attributes to Resource level for metrics
          - set(resource.attributes["gen_ai.system"], attributes["gen_ai.system"]) where attributes["gen_ai.system"] != nil
          - set(resource.attributes["db.system"], attributes["db.system"]) where attributes["db.system"] != nil
          # Handle vLLM metrics (explicitly NOT renaming vllm: as requested)

  resource:
    attributes:
      - key: service.namespace
        value: "suse-ai"
        action: upsert
      # Standardize identity
      - key: suse.ai.component
        from_attribute: gen_ai.system
        action: insert
      - key: suse.ai.component
        from_attribute: db.system
        action: insert

  batch:
    send_batch_size: 1000
    timeout: 10s

exporters:
  debug:
    verbosity: detailed
  otlp:
    endpoint: "suse-observability-otel-collector.observability.svc.cluster.local:4317"
    tls:
      insecure: true

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resourcedetection, k8sattributes, transform, resource, batch]
      exporters: [debug, otlp]
    metrics:
      receivers: [otlp, prometheus, elasticsearch]
      processors: [resourcedetection, k8sattributes, transform, resource, batch]
      exporters: [debug, otlp]
    logs:
      receivers: [otlp]
      processors: [resourcedetection, k8sattributes, transform, resource, batch]
      exporters: [debug, otlp]
